<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>汇编语言（王爽）ch5 | CodeSaw</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/css/highlight.css">
  
  <meta name="description" content="第五部分:中断II Abstract  CPU实现I/O功能的两个问题:从何处获得外设的输入？如何解决外设输入随时可能发生的问题？首先外设芯片内部有若干寄存器，CPU将这些寄存器当做端口来访问。外设的输入输出不直接送入CPU和内存而是通过这些寄存器。第二，CPU通过外中断控制I/O的随时性。">
<meta name="keywords" content="i386">
<meta property="og:type" content="article">
<meta property="og:title" content="汇编语言（王爽）ch5">
<meta property="og:url" content="http://haotianmcihael.github.io/2018/10/16/汇编语言（王爽）ch5/index.html">
<meta property="og:site_name" content="CodeSaw">
<meta property="og:description" content="第五部分:中断II Abstract  CPU实现I/O功能的两个问题:从何处获得外设的输入？如何解决外设输入随时可能发生的问题？首先外设芯片内部有若干寄存器，CPU将这些寄存器当做端口来访问。外设的输入输出不直接送入CPU和内存而是通过这些寄存器。第二，CPU通过外中断控制I/O的随时性。">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://haotianmcihael.github.io/2018/10/16/汇编语言（王爽）ch5/25.png">
<meta property="og:updated_time" content="2020-06-26T02:29:26.340Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="汇编语言（王爽）ch5">
<meta name="twitter:description" content="第五部分:中断II Abstract  CPU实现I/O功能的两个问题:从何处获得外设的输入？如何解决外设输入随时可能发生的问题？首先外设芯片内部有若干寄存器，CPU将这些寄存器当做端口来访问。外设的输入输出不直接送入CPU和内存而是通过这些寄存器。第二，CPU通过外中断控制I/O的随时性。">
<meta name="twitter:image" content="http://haotianmcihael.github.io/2018/10/16/汇编语言（王爽）ch5/25.png"></head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1 id="title">
    <a href="/">CodeSaw</a>
  </h1>
  <nav>
    
    
      
      <a class="nav-link" href="/">Home</a>
    
      
        <span class="nav-spacer">×</span>
      
      <a class="nav-link" href="/archives">Archives</a>
    
    
  </nav>
</header>

    <div id="content">
      <article id="post-汇编语言（王爽）ch5" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="headline name">
      汇编语言（王爽）ch5
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2018-10-15T16:32:55.000Z" itemprop="datePublished">2018-10-15</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h2 id="第五部分中断ii">第五部分:中断II</h2>
<h3 id="abstract">Abstract</h3>
<blockquote>
<p>CPU实现I/O功能的两个问题:从何处获得外设的输入？如何解决外设输入随时可能发生的问题？首先外设芯片内部有若干寄存器，CPU将这些寄存器当做端口来访问。外设的输入输出不直接送入CPU和内存而是通过这些寄存器。第二，CPU通过外中断控制I/O的随时性。 <a id="more"></a></p>
</blockquote>
<h3 id="端口">端口</h3>
<blockquote>
<p>CPU可以直接读写三个地方的数据: * 内部寄存器 * 内存单元 * 端口 CPU通过端口地址来定位不同的端口，最多可以定位64KB个端口，则端口地址范围为<code>0~65535</code>。端口的读写指令<code>in</code>和<code>out</code>。只能使用<code>al</code>和<code>ax</code>来存放对端口进行读写的数据。</p>
</blockquote>
<h3 id="外中断">外中断</h3>
<blockquote>
<p>外中断是由相关芯片发送给CPU中的。分为<strong>可屏蔽中断</strong>和<strong>不可屏蔽中断</strong>。不可屏蔽中断指那些CPU一定需要响应的中断，这种中断很少，中断类型码固定为2。大多数外中断指的是可屏蔽中断。<br>
CPU要不要响应可屏蔽中断完全取决于状态寄存器的<code>IF</code>位。为1则响应，否则不响应。8086中手动设置<code>IF</code>的指令: * <code>sti</code>:设置为1 * <code>cli</code>:设置为0</p>
</blockquote>
<h3 id="实验-编写9号中断例程">实验 编写9号中断例程</h3>
<h4 id="pc机键盘的处理过程">PC机键盘的处理过程</h4>
<blockquote>
<p>键盘中有一个芯片扫描每一个键的状态——按下还是松开。按下产生一个扫描码称为<strong>通码</strong>，松开也产生一个扫描码称为<strong>断码</strong>。<code>断码=通码+80h</code>。扫描码被送到<code>60h</code>端口中。<br>
<code>int 9h</code>是BIOS提供的不可屏蔽中断。一旦CPU收到该信号: * 读出<code>60h</code>端口的扫描码 * 如果是字符键的扫描码，将该扫描码和所对应的字符码送入内存中的BIOS键盘缓存区(16个字单元)。如果是控制键(Ctrl)和切换键(CapsLock)的扫描码，则将其转变为状态字节写进内存中存储状态字节的单元。 * 对键盘系统进行相关的控制。</p>
</blockquote>
<h4 id="实验">实验</h4>
<blockquote>
<p>在屏幕中间依次显示&quot;a&quot;~&quot;z&quot;,在显示的过程中按下Esc键后改变颜色。<br>
实验有意思的地方在于:因为键盘上所有的键都会触发<code>int 9h</code>中断，<strong>需要在保证其他键无效的情况下，Esc键触发中断</strong>————就相当于出现了两个中断例程，两个中断向量。更有趣的是需要这两个中断同时有效，在一个<code>int 9h</code>中断下！<br>
方法也很简单，就是使用<code>if_else</code>判断扫描码。当然汇编中没有<code>if_else</code>。</p>
</blockquote>
<h4 id="中断向量和中断例程">中断向量和中断例程</h4>
<blockquote>
<p>键盘无论是哪一个键当然只会触发<code>int 9h</code>中断这个不会变。不过得分别写例程:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">	stack segment</span><br><span class="line">		db 128 dup (0)</span><br><span class="line">	stack ends</span><br><span class="line">	</span><br><span class="line">	data segment</span><br><span class="line">		dw 0,0</span><br><span class="line">	data ends</span><br><span class="line">	</span><br><span class="line">	code segment</span><br><span class="line">	start:</span><br><span class="line">		mov ax,stack</span><br><span class="line">		mov ss,ax</span><br><span class="line">		mov sp,128</span><br><span class="line">		</span><br><span class="line">		mov ax,data</span><br><span class="line">		mov ds,ax</span><br><span class="line">		</span><br><span class="line">		mov ax,0</span><br><span class="line">		mov es,ax</span><br><span class="line">		</span><br><span class="line">		push es:[9*4]</span><br><span class="line">		pop ds:[0]</span><br><span class="line">		push es:[9*4+2]</span><br><span class="line">		pop ds:[2]</span><br><span class="line">		</span><br><span class="line">		mov word ptr es:[9*4],offset int 9</span><br><span class="line">		mov es:[9*4+2],cs</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面的代码主要就是设置了中断向量表。可以看到讲原来的<code>int 9h</code>中断例程地址保存在ds:0,ds:2地址处，换上新的例程地址<code>cs:(offset int 9)</code>。新的例程代码: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">int9:	push ax</span><br><span class="line">	push bx</span><br><span class="line">	push es</span><br><span class="line"></span><br><span class="line">	in al,60h</span><br><span class="line"></span><br><span class="line">	pushf</span><br><span class="line">	call dword ptr ds:[0]   ;这里的实际上模拟了int 9中断例程的功能，实现子程序中的调用</span><br><span class="line"></span><br><span class="line">	cmp al,1</span><br><span class="line">	jne int9ret</span><br><span class="line"></span><br><span class="line">	;下面是Esc例程代码</span><br><span class="line">	</span><br><span class="line">	mov ax,0b800h</span><br><span class="line">	mov es,ax</span><br><span class="line">	inc byte ptr es:[160*12+40*2+1]  ;改变属性值，改变颜色</span><br><span class="line"></span><br><span class="line">int9ret:pop es</span><br><span class="line">	pop bx</span><br><span class="line">	pop ax</span><br><span class="line">	iret</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>其中<code>cmp al,1</code>和<code>jne int9ret</code>就相当于<code>if_else</code>的功能。在主程序中有了栈，栈在中断例程中的主要作用就是保护现场，分析一下:<br>
* 需要保护最开始的<code>int 9h</code>的中断向量号 * 因为在显示字符的主程序中，<code>ax</code>,<code>es</code>,<code>bx</code>都保存了重要的中间参数，所以需要保护 除此之外,栈并没有起到什么作用。这样看下来其实源程序也简单了不少。 <img src="25.png" width="50%" height="50%" alt=""></p>
</blockquote>

      
    </div>
    
    
    <div class="article-category">
      
        <b>Categories:</b>
        <a class="article-category-link" href="/categories/Assembly/">Assembly</a>
      
      
        <br/>
      
      
        <b>Tags:</b>
        <a class="article-tag-link" href="/tags/i386/">i386</a>
      
    </div>
    
    
  </div>
</article>

  
<nav id="article-nav" class="article-nav">
  
    <a href="/2018/11/05/Mit6-828-Fall-2018-Lab0/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Mit6.828(Fall 2018) Lab0
        
      </div>
    </a>
  
  
    <a href="/2018/10/12/汇编语言（王爽）ch4/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          汇编语言（王爽）ch4
        
      </div>
    </a>
  
</nav>






    </div>
  </div>
  




<div id="settings-container">
  <div id="dark-mode">dark</div>
  <div id="sans-font">sans</div>
</div>
<script type="text/javascript">
let d=document,r=d.documentElement.style,f=r.setProperty.bind(r),l=localStorage,s=l.getItem('s')||(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches),n=l.getItem('n'),m=d.getElementById("dark-mode"),b=()=>{f('--bg-color','#fafafa');f('--code-bg-color','#f4f4f4');f('--text-color','#212121');f('--secondary-color','#808080');f('--tertiary-color','#b0b0b0');f('--link-color','#b5c8cf');f('--link-hover-color','#618794');f('--link-bg-color','#dae4e7');f('--selection-color','#dae4e7');m.innerHTML="dark"},c=()=>{f('--bg-color','#212121');f('--code-bg-color','#292929');f('--text-color','#fff');f('--secondary-color','#c0c0c0');f('--tertiary-color','#6e6e6e');f('--link-color','#4d6b75');f('--link-hover-color','#96b1bb');f('--link-bg-color','#5d828e');f('--selection-color','#acc1c9');m.innerHTML="light"},o=d.getElementById("sans-font"),e=()=>{f('--body-stack','"Lora", "Georgia", "Times New Roman", serif');o.innerHTML="sans"},g=()=>{f('--body-stack','"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif');o.innerHTML="serif"};m.onclick=()=>{if(s==2){s=1;l.setItem('s',s);c()}else{s=2;l.setItem('s',s);b()}};o.onclick=()=>{if(n==2){n=1;l.setItem('n',n);g()}else{n=2;l.setItem('n',n);e()}};if(!s){s=2;l.setItem('s',2)};if(s==1){c()};if(!n){n=2;l.setItem('n',2)};if(n==1){g()};
</script>




<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<!--<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->
<!--<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->

</body>
</html>
